# NKP Deployment Specification
# This file defines the complete configuration for an NKP 2.16 deployment
# Used by Claude Code to automate the deployment process
#
# Instructions:
# 1. Fill in all required values (marked with <REQUIRED>)
# 2. Review optional values and adjust as needed
# 3. Provide this file to Claude Code along with the prompts

apiVersion: nkp.nutanix.com/v1alpha1
kind: DeploymentSpec
metadata:
  name: nkp-management-cluster
  description: "NKP 2.16 Management Cluster Deployment Specification"
  version: "2.16"
  createdAt: ""  # Will be set during deployment

# =============================================================================
# DEPLOYMENT TYPE AND ENVIRONMENT
# =============================================================================
deployment:
  # Type: nutanix | preprovisioned | aws | azure | gcp | vsphere
  type: preprovisioned
  
  # Environment: non-airgapped | airgapped
  environment: non-airgapped
  
  # License tier: starter | pro | ultimate
  licenseTier: pro
  
  # Make this a self-managed cluster (recommended for management cluster)
  selfManaged: true

# =============================================================================
# CLUSTER CONFIGURATION
# =============================================================================
cluster:
  # Cluster name (lowercase, alphanumeric, hyphens only)
  name: "<REQUIRED: e.g., nkp-mgmt-prod>"
  
  # Kubernetes version (leave empty for default)
  kubernetesVersion: ""
  
  # Control plane configuration
  controlPlane:
    # Virtual IP for the Kubernetes API server (must be unused IP in same subnet)
    endpoint:
      host: "<REQUIRED: e.g., 192.168.1.100>"
      port: 6443
    
    # Number of control plane replicas (1, 3, 5, or 7)
    replicas: 3
    
    # Use built-in virtual IP (kube-vip) instead of external load balancer
    useVirtualIP: true
    virtualIPInterface: ""  # e.g., "eth0" - leave empty for auto-detect
    
  # Worker node configuration
  workers:
    # Number of worker replicas
    replicas: 4
    
    # Additional worker pools (optional)
    additionalPools: []
    # - name: gpu-workers
    #   replicas: 2
    #   labels:
    #     node-type: gpu

# =============================================================================
# NODE INVENTORY (Pre-provisioned only)
# =============================================================================
nodes:
  # SSH configuration for all nodes
  ssh:
    user: "<REQUIRED: e.g., konvoy>"
    port: 22
    privateKeyFile: "<REQUIRED: e.g., /home/user/.ssh/id_rsa>"
  
  # Control plane nodes (minimum 3 for HA)
  controlPlane:
    - address: "<REQUIRED: e.g., 192.168.1.51>"
      # hostname: cp1  # Optional
    - address: "<REQUIRED: e.g., 192.168.1.52>"
    - address: "<REQUIRED: e.g., 192.168.1.53>"
  
  # Worker nodes (minimum 4 recommended)
  workers:
    - address: "<REQUIRED: e.g., 192.168.1.61>"
    - address: "<REQUIRED: e.g., 192.168.1.62>"
    - address: "<REQUIRED: e.g., 192.168.1.63>"
    - address: "<REQUIRED: e.g., 192.168.1.64>"

# =============================================================================
# NETWORKING CONFIGURATION
# =============================================================================
networking:
  # Pod network CIDR (default: 10.244.0.0/16)
  podCIDR: "10.244.0.0/16"
  
  # Service network CIDR (default: 10.96.0.0/12)
  serviceCIDR: "10.96.0.0/12"
  
  # CNI plugin: cilium | calico
  cni: cilium
  
  # MetalLB configuration for LoadBalancer services
  metallb:
    enabled: true
    # Mode: layer2 | bgp
    mode: layer2
    # IP address range for LoadBalancer services (must be in same subnet as nodes)
    ipRange: "<REQUIRED: e.g., 192.168.1.240-192.168.1.250>"
    
    # BGP configuration (only if mode is bgp)
    bgp:
      localASN: 64500
      peers: []
      # - peerAddress: "10.0.0.1"
      #   peerASN: 64501

  # HTTP/HTTPS proxy configuration (if required)
  proxy:
    enabled: false
    httpProxy: ""
    httpsProxy: ""
    noProxy: ""

# =============================================================================
# STORAGE CONFIGURATION
# =============================================================================
storage:
  # Default storage provider: nutanix-csi | rook-ceph | local-volume-provisioner
  defaultProvider: local-volume-provisioner
  
  # Nutanix CSI configuration (if using Nutanix storage)
  nutanixCSI:
    enabled: false
    prismCentral:
      endpoint: ""
      username: ""
      # Password should be in environment variable: NUTANIX_PASSWORD
    prismElement:
      clusterUUID: ""
      storageContainer: ""
    options:
      hypervisorAttached: true
      flashMode: false
  
  # Rook Ceph configuration (for pre-provisioned with dedicated disks)
  rookCeph:
    enabled: false
    # Minimum 3 nodes with raw disks required
    deviceFilter: ""  # e.g., "^sd[b-z]$"
    osdPerDevice: 1
    replicaCount: 3
  
  # Local volume provisioner (default for pre-provisioned)
  localVolumeProvisioner:
    enabled: true
    # Path where local volumes will be discovered
    discoveryPath: "/mnt/disks"

# =============================================================================
# KOMMANDER CONFIGURATION
# =============================================================================
kommander:
  # Install Kommander dashboard
  enabled: true
  
  # Installation timeout
  waitTimeout: "45m"
  
  # Custom domain configuration (optional)
  customDomain:
    enabled: false
    domain: ""
    # Certificate configuration
    certificate:
      # secretName if using existing certificate
      secretName: ""
      # Or use cert-manager
      useCertManager: false
      issuerName: ""
  
  # Platform applications to enable/disable
  applications:
    prometheus: true
    grafana: true
    traefik: true
    certManager: true
    velero: true
    gatekeeper: true
    # kubecost is Ultimate only
    kubecost: false
    
  # AI Navigator (Pro and Ultimate only)
  aiNavigator:
    enabled: true

# =============================================================================
# LICENSE CONFIGURATION
# =============================================================================
license:
  # License token (or set NKP_LICENSE_TOKEN environment variable)
  # Leave empty to apply via UI after deployment
  token: ""
  
  # License type for validation
  expectedTier: pro  # starter | pro | ultimate

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
security:
  # Rotate default dashboard password after installation
  rotateDefaultPassword: true
  
  # Pod Security Standards enforcement level: privileged | baseline | restricted
  podSecurityStandard: baseline
  
  # Enable network policies
  enableNetworkPolicies: true
  
  # Identity provider configuration (optional, configure via UI is easier)
  identityProvider:
    enabled: false
    type: ""  # ldap | oidc | saml
    # Configuration details depend on type

# =============================================================================
# BACKUP CONFIGURATION
# =============================================================================
backup:
  # Configure Velero for backups
  velero:
    enabled: true
    # Backup storage location
    provider: ""  # aws | azure | gcp | minio
    bucket: ""
    # Credentials via environment variables or secret

# =============================================================================
# AIR-GAPPED CONFIGURATION (if environment is airgapped)
# =============================================================================
airgapped:
  # Local registry for container images
  registry:
    url: ""  # e.g., "registry.local:5000"
    caCertFile: ""
    username: ""
    # Password via REGISTRY_PASSWORD environment variable
  
  # Bundle paths
  bundles:
    konvoyImages: ""  # Path to konvoy image bundle tar
    kommanderImages: ""  # Path to kommander image bundle tar
    kommanderCharts: ""  # Path to kommander charts bundle tar

# =============================================================================
# ADVANCED OPTIONS
# =============================================================================
advanced:
  # Additional flags for cluster creation
  extraClusterCreateFlags: []
  # - "--dry-run"
  # - "--verbose"
  
  # Custom YAML overrides
  overrides:
    enabled: false
    # Path to override files
    controlPlaneOverride: ""
    workerOverride: ""
  
  # Calico encapsulation mode (if using Calico)
  calicoEncapsulation: "VXLAN"  # VXLAN | IPIPCrossSubnet | IPIP
  
  # Enable FIPS mode
  fipsMode: false

# =============================================================================
# OUTPUT CONFIGURATION
# =============================================================================
output:
  # Directory for generated files
  directory: "./nkp-output"
  
  # Generate these files after deployment
  generateFiles:
    kubeconfig: true
    deploymentReport: true
    accessCredentials: true

# =============================================================================
# VALIDATION RULES
# =============================================================================
validation:
  # Pre-flight checks to run
  preflightChecks:
    - sshConnectivity
    - nodePrerequisites
    - networkConnectivity
    - diskSpace
    - portAvailability
    - timeSync
    - dnsResolution
  
  # Skip specific checks (not recommended)
  skipChecks: []
